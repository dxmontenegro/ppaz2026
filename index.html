<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>EEFM PARÓQUIA DA PAZ - SISTEC</title>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #004d7a, #008793, #00bf72, #a8eb12);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: rgba(0,0,0,0.6);
      color: #fff;
      width: 100%;
      padding: 20px;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      margin-top: 30px;
      width: 90%;
      max-width: 650px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    h2 {
      text-align: center;
      color: #004d7a;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }
    button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1.05em;
      font-weight: bold;
      cursor: pointer;
      transition: 0.25s;
    }
    .btn-primary { background: #004d7a; color: #fff; }
    .btn-primary:hover { background: #006494; }
    .btn-secondary { background: #00bf72; color: #fff; }
    .btn-secondary:hover { background: #009f60; }
    .btn-google { background: #4285F4; color: #fff; }
    .btn-google:hover { background: #357ae8; }
    .hidden { display: none; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .status {
      margin-top: 10px;
      font-size: 0.95em;
      color: #555;
      text-align: center;
    }
    .note {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 0.9em;
      color: #444;
    }
  </style>
</head>
<body>
  <header>EEFM PARÓQUIA DA PAZ - SISTEC</header>

  <!-- Navegação -->
  <div class="container" id="home">
    <div class="row">
      <button id="btnCadastro" class="btn-primary">Cadastro de Pasta</button>
      <button id="btnBusca" class="btn-secondary">Busca de Pasta</button>
    </div>
    <div class="status" id="status">Status: não autenticado</div>
    <button id="btnLogin" class="btn-google">Entrar com Google</button>
    <div class="note">
      Observação: faça login antes de cadastrar para criar a pasta e enviar os arquivos ao Google Drive.
    </div>
  </div>

  <!-- Aba de Cadastro -->
  <div id="cadastro" class="container hidden">
    <h2>Cadastro de Pasta</h2>
    <form id="cadastroForm">
      <div class="row">
        <label>Ano:
          <input type="number" id="anoCadastro" required min="2000" max="2100" />
        </label>
        <label>Turno:
          <select id="turnoCadastro" required>
            <option value="">Selecione</option>
            <option>Manhã</option>
            <option>Tarde</option>
            <option>Noite</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>Série:
          <select id="serieCadastro" required>
            <option value="">Selecione</option>
            <option>8º EF</option>
            <option>9º EF</option>
            <option>1º EM</option>
            <option>2º EM</option>
            <option>3º EM</option>
          </select>
        </label>
        <label>Turma:
          <input type="text" id="turmaCadastro" maxlength="1" required />
        </label>
      </div>
      <label>Arquivos (PDF):
        <input type="file" id="arquivosCadastro" accept="application/pdf" multiple required />
      </label>
      <button type="button" id="btnCadastrar" class="btn-primary" disabled>Cadastrar</button>
      <div class="status" id="statusCadastro">Aguardando login...</div>
    </form>
  </div>

  <!-- Aba de Busca -->
  <div id="busca" class="container hidden">
    <h2>Busca de Pasta</h2>
    <form id="buscaForm">
      <div class="row">
        <label>Ano:
          <input type="number" id="anoBusca" required min="2000" max="2100" />
        </label>
        <label>Turno:
          <select id="turnoBusca" required>
            <option value="">Selecione</option>
            <option>Manhã</option>
            <option>Tarde</option>
            <option>Noite</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>Série:
          <select id="serieBusca" required>
            <option value="">Selecione</option>
            <option>8º EF</option>
            <option>9º EF</option>
            <option>1º EM</option>
            <option>2º EM</option>
            <option>3º EM</option>
          </select>
        </label>
        <label>Turma:
          <input type="text" id="turmaBusca" maxlength="1" required />
        </label>
      </div>
      <button type="button" id="btnBuscar" class="btn-secondary">Buscar</button>
      <div class="status" id="resultadoBusca"></div>
    </form>
  </div>

  <script>
    // ====== CONFIGURAÇÃO GOOGLE API ======
    const CLIENT_ID = "616758753388-298vkgpv426aip21vc8cc5tjuhnj3anp.apps.googleusercontent.com";
    const API_KEY = "AIzaSyCbD1jfh_G5GE0tOxwaJMKrLGUwZ2RPzEY";   
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let isSignedIn = false;

    function ensureGapiLoaded() {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function waitForGapi() {
          if (window.gapi && gapi.load) return resolve();
          if (Date.now() - start > 8000) return reject(new Error("gapi não carregou"));
          setTimeout(waitForGapi, 100);
        })();
      });
    }

    async function initGapi() {
      try {
        await ensureGapiLoaded();
        await new Promise((resolve, reject) => {
          gapi.load("client:auth2", {
            callback: resolve,
            onerror: () => reject(new Error("Falha ao carregar client:auth2")),
          });
        });

        await gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
        });

        const auth = gapi.auth2.getAuthInstance();
        isSignedIn = auth.isSignedIn.get();
        updateAuthUI();

        auth.isSignedIn.listen((signed) => {
          isSignedIn = signed;
          updateAuthUI();
        });
      } catch (err) {
        console.error("Erro ao inicializar Google API:", err);
        document.getElementById("status").textContent = "Status: erro ao carregar Google API";
        document.getElementById("statusCadastro").textContent = "Erro ao carregar Google API";
      }
    }

    function updateAuthUI() {
      const status = document.getElementById("status");
      const statusCadastro = document.getElementById("statusCadastro");
      const btnCadastrar = document.getElementById("btnCadastrar");

      if (isSignedIn) {
        status.textContent = "Status: autenticado";
        statusCadastro.textContent = "Pronto para cadastrar.";
        btnCadastrar.disabled = false;
      } else {
        status.textContent = "Status: não autenticado";
        statusCadastro.textContent = "Aguardando login...";
        btnCadastrar.disabled = true;
      }
    }

    async function signIn() {
      try {
        await initGapi();
        const auth = gapi.auth2.getAuthInstance();
        if (!auth.isSignedIn.get()) {
          await auth.signIn();
        }
        isSignedIn = true;
        updateAuthUI();
      } catch (err) {
        console.error("Erro no login:", err);
        alert("Falha no login. Verifique Client ID e API Key.");
      }
    }

    // ====== UI: NAVEGAÇÃO ENTRE ABAS ======
    function showCadastro() {
      document.getElementById("cadastro").classList.remove("hidden");
      document.getElementById("busca").classList.add("hidden");
    }
    function showBusca() {
      document.getElementById("busca").classList.remove("hidden");
      document.getElementById("cadastro").classList.add("hidden");
    }

    // ====== LÓGICA: CADASTRO E UPLOAD ======
    async function uploadCadastro() {
      const ano = document.getElementById("anoCadastro").value.trim();
      const turno = document.getElementById("turnoCadastro").value.trim();
      const serie = document.getElementById("serieCadastro").value.trim();
      const turma = document.getElementById("turmaCadastro").value.trim().toUpperCase();
      const files = document.getElementById("arquivosCadastro").files;

      if (!ano || !turno || !serie || !turma || files.length === 0) {
        alert("Preencha todos os campos e selecione ao menos um PDF!");
        return;
      }
      if (!isSignedIn) {
        alert("Faça login no Google antes de cadastrar.");
        return;
      }

      const folderName = `${ano}_${turno}_${serie}_${turma}`;
      const accessToken = gapi.auth.getToken().access_token;

      // 1) Verifica se a pasta já existe
      const searchRes = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: "files(id, name)"
      });
      let folderId = searchRes.result.files?.[0]?.id;

      // 2) Cria se não existir
      if (!folderId) {
        const folderMetadata = {
          name: folderName,
          mimeType: "application/vnd.google-apps.folder"
        };
        const folderResponse = await fetch("https://www.googleapis.com/drive/v3/files", {
          method: "POST",
          headers: new Headers({
            "Authorization": "Bearer " + accessToken,
            "Content-Type": "application/json"
          }),
          body: JSON.stringify(folderMetadata)
        });
        const folder = await folderResponse.json();
        folderId = folder.id;
      }

      // 3) Upload dos arquivos
      for (let file of files) {
        const metadata = { name: file.name, parents: [folderId] };
        const form = new FormData();
        form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        form.append("file", file);

        const upRes = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
          method: "POST",
          headers: new Headers({ "Authorization": "Bearer " + accessToken }),
          body: form
        });

        if (!upRes.ok) {
          const err = await upRes.text();
          console.error("Erro upload:", err);
          alert("Falha ao enviar um arquivo. Veja o console para detalhes.");
          return;
        }
      }

      alert("Pasta cadastrada e arquivos enviados com sucesso!");
    }

    // ====== LÓGICA: BUSCA ======
    async function buscarPasta() {
      const ano = document.getElementById("anoBusca").value.trim();
      const turno = document.getElementById("turnoBusca").value.trim();
      const serie = document.getElementById("serieBusca").value.trim();
      const turma = document.getElementById("turmaBusca").value.trim().toUpperCase();
      const resultEl = document.getElementById("resultadoBusca");

      if (!ano || !turno || !serie || !turma) {
        alert("Preencha todos os campos!");
        return;
      }

      await initGapi(); // garante que a API está pronta para listar
      const folderName = `${ano}_${turno}_${serie}_${turma}`;
      const res = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: "files(id, name)"
      });

      const files = res.result.files || [];
      if (files.length > 0) {
        resultEl.textContent = `Pasta encontrada: ${files[0].name} (ID: ${files[0].id})`;
      } else {
        resultEl.textContent = "Nenhuma pasta encontrada com esse nome.";
      }
    }

    // ====== EVENT LISTENERS (sem inline onclick) ======
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnCadastro").addEventListener("click", showCadastro);
      document.getElementById("btnBusca").addEventListener("click", showBusca);
      document.getElementById("btnLogin").addEventListener("click", signIn);
      document.getElementById("btnCadastrar").addEventListener("click", uploadCadastro);
      document.getElementById("btnBuscar").addEventListener("click", buscarPasta);
    });
  </script>
</body>

</html>


